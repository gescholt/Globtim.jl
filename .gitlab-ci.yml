# GitLab CI/CD configuration for Globtim.jl

stages:
  - test
  - coverage

variables:
  JULIA_DEPOT_PATH: "$CI_PROJECT_DIR/.julia"
  JULIA_NUM_THREADS: 4

# Cache Julia packages between runs
.julia_cache:
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - .julia/artifacts
      - .julia/compiled
      - .julia/packages
      - .julia/registries

# Test job for Julia 1.11
test:julia-1.11:
  stage: test
  image: julia:1.11
  tags:
    - docker
  extends: .julia_cache
  script:
    - julia --version
    - julia --project=@. -e 'using Pkg; Pkg.instantiate(); Pkg.resolve()'
    - julia --project=@. -e 'using Pkg; Pkg.test(coverage=true)'
  coverage: '/Test coverage (\d+\.\d+)%/'
  artifacts:
    when: always
    paths:
      - .julia/logs
    reports:
      junit: .julia/logs/junit.xml
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "clean-version"'

# Test on Julia 1.10 for compatibility
test:julia-1.10:
  stage: test
  image: julia:1.10
  tags:
    - docker
  extends: .julia_cache
  script:
    - julia --version
    - julia --project=@. -e 'using Pkg; Pkg.instantiate(); Pkg.resolve()'
    - julia --project=@. -e 'using Pkg; Pkg.test()'
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Coverage analysis
coverage:
  stage: coverage
  image: julia:1.11
  tags:
    - docker
  extends: .julia_cache
  dependencies:
    - test:julia-1.11
  script:
    - julia --version
    - julia --project=@. -e 'using Pkg; Pkg.instantiate()'
    - julia --project=@. -e '
        using Pkg;
        Pkg.test(coverage=true);
        using Coverage;

        # Process coverage
        coverage = process_folder();
        coverage_summary = get_summary(coverage);

        # Print coverage summary
        covered = coverage_summary.covered;
        total = coverage_summary.total;
        percentage = round(100 * covered / total, digits=2);
        println("Test coverage: ", percentage, "%");

        # Generate detailed coverage report
        LCOV.writefile("coverage.info", coverage);
      '
  coverage: '/Test coverage: (\d+\.\d+)%/'
  artifacts:
    paths:
      - coverage.info
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'

# Quick syntax check (runs on all branches)
syntax-check:
  stage: test
  image: julia:1.11
  tags:
    - docker
  script:
    - julia --version
    - find src -name "*.jl" -exec julia --syntax-check {} \;
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
  allow_failure: true
