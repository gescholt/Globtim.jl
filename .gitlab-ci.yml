# GitLab CI/CD configuration for Globtim.jl

stages:
  - check
  - format
  - test
  - coverage

variables:
  JULIA_DEPOT_PATH: "$CI_PROJECT_DIR/.julia"
  JULIA_NUM_THREADS: "4"

# Format check job - runs early to catch style issues
format-check:
  stage: format
  before_script:
    - echo "Installing Julia via juliaup..."
    - curl -fsSL https://install.julialang.org | sh -s -- -y
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - juliaup add 1.11
    - juliaup default 1.11
  cache:
    key: "format-check-$CI_COMMIT_REF_SLUG"
    paths:
      - .julia/
      - $HOME/.juliaup/
  script:
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - julia --version
    - echo "Running Julia formatter check..."
    - ./scripts/format-julia.sh --check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "clean-version"'
  allow_failure: true  # Start with allow_failure, can be made strict later

# Check runner environment and capabilities
check-environment:
  stage: check
  script:
    - echo "=== System Information ==="
    - uname -a
    - cat /etc/os-release || true
    - echo "=== Check for Docker ==="
    - docker --version || echo "Docker not found"
    - echo "=== Check for package managers ==="
    - which apt-get && echo "apt-get available" || echo "apt-get not found"
    - which yum && echo "yum available" || echo "yum not found"
    - which snap && echo "snap available" || echo "snap not found"
    - echo "=== Check for Node.js and npm ==="
    - which node && node --version || echo "Node.js not found"
    - which npm && npm --version || echo "npm not found"
    - echo "=== Check for Julia ==="
    - which julia && julia --version || echo "Julia not found"
    - echo "=== Attempting to install Julia via juliaup ==="
    - curl -fsSL https://install.julialang.org | sh -s -- -y || echo "juliaup installation failed"
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - which julia && julia --version || echo "Julia still not found after juliaup"
    - echo "=== Environment variables ==="
    - env | grep -i julia || true
    - echo "=== Current directory ==="
    - pwd
    - ls -la
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'

# Test job for Julia 1.11 using shell approach
test:julia-1.11-shell:
  stage: test
  before_script:
    - echo "Installing Julia via juliaup..."
    - curl -fsSL https://install.julialang.org | sh -s -- -y
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - juliaup add 1.11
    - juliaup default 1.11
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - .julia/
      - $HOME/.juliaup/
  script:
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - julia --version
    - julia --project=@. -e 'using Pkg; Pkg.instantiate(); Pkg.resolve()'
    - julia --project=@. -e 'using Pkg; Pkg.test(coverage=true)'
  coverage: '/Test coverage (\d+\.\d+)%/'
  artifacts:
    when: always
    paths:
      - .julia/logs
      - "**/*.cov"  # Coverage data files
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "clean-version"'

# Keep original Docker-based job for comparison
test:julia-1.11:
  stage: test
  image: julia:1.11
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - .julia/
  script:
    - julia --version
    - julia --project=@. -e 'using Pkg; Pkg.instantiate(); Pkg.resolve()'
    - julia --project=@. -e 'using Pkg; Pkg.test(coverage=true)'
  coverage: '/Test coverage (\d+\.\d+)%/'
  artifacts:
    when: always
    paths:
      - .julia/logs
      - "**/*.cov"  # Coverage data files
    expire_in: 1 week
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "clean-version"'

# Test on Julia 1.10 for compatibility - shell approach
test:julia-1.10-shell:
  stage: test
  before_script:
    - curl -fsSL https://install.julialang.org | sh -s -- -y
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - juliaup add 1.10
    - juliaup default 1.10
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - .julia/
      - $HOME/.juliaup/
  script:
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - julia --version
    - julia --project=@. -e 'using Pkg; Pkg.instantiate(); Pkg.resolve()'
    - julia --project=@. -e 'using Pkg; Pkg.test()'
  allow_failure: true
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'

# Quick syntax check - shell approach
syntax-check-shell:
  stage: test
  before_script:
    - curl -fsSL https://install.julialang.org | sh -s -- -y
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - juliaup add 1.11
    - juliaup default 1.11
  script:
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - julia --version
    - find src -name "*.jl" -exec julia --syntax-check {} \;
  rules:
    - if: '$CI_PIPELINE_SOURCE == "push"'
  allow_failure: true

# Coverage analysis job - shell approach
coverage-shell:
  stage: coverage
  before_script:
    - curl -fsSL https://install.julialang.org | sh -s -- -y
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - juliaup add 1.11
    - juliaup default 1.11
  dependencies:
    - test:julia-1.11-shell
  cache:
    key: "$CI_JOB_NAME-$CI_COMMIT_REF_SLUG"
    paths:
      - .julia/
      - $HOME/.juliaup/
  script:
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - julia --version
    - julia --project=@. -e 'using Pkg; Pkg.instantiate()'
    - |
      julia --project=@. -e '
        using Coverage
        # Process coverage data from src directory
        coverage = process_folder("src")
        # Generate coverage summary
        covered_lines, total_lines = get_summary(coverage)
        percentage = round(100 * covered_lines / total_lines; digits=2)
        println("Test coverage $(percentage)%")
        # Generate LCOV report for GitLab
        LCOV.writefile("coverage.lcov", coverage)
      '
  coverage: '/Test coverage (\d+\.\d+)%/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.lcov
    paths:
      - coverage.lcov
    expire_in: 1 week
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "clean-version"'

# Aqua.jl code quality check
aqua-quality-check:
  stage: test
  before_script:
    - curl -fsSL https://install.julialang.org | sh -s -- -y
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - juliaup add 1.11
    - juliaup default 1.11
  cache:
    key: "aqua-$CI_COMMIT_REF_SLUG"
    paths:
      - .julia/
      - $HOME/.juliaup/
  script:
    - export PATH="$HOME/.juliaup/bin:$PATH"
    - julia --version
    - julia --project=test -e 'using Pkg; Pkg.instantiate()'
    - julia scripts/run-aqua-tests.jl --ci --verbose
  artifacts:
    when: on_failure
    paths:
      - aqua_report.txt
    expire_in: 1 week
  allow_failure: true  # Start with allow_failure, make strict later
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
    - if: '$CI_COMMIT_BRANCH == "main"'
