# Circular Dependency Prevention CI Check
name: Circular Dependency Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'Project.toml'
      - 'Manifest.toml'
      - 'src/**'
      - 'ext/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'Project.toml'
      - 'Manifest.toml'
      - 'src/**'
      - 'ext/**'

jobs:
  validate-dependencies:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Julia
      uses: julia-actions/setup-julia@v1
      with:
        version: '1.11'

    - name: Validate Project.toml structure
      run: |
        echo "üîç Running Project.toml validation..."
        julia tools/validation/validate_project_toml.jl

    - name: Test package loading isolation
      run: |
        echo "üß™ Testing core package loading in isolation..."
        julia --project=. -e "using Pkg; Pkg.instantiate()"
        julia --project=. -e "using Globtim; println(\"‚úÖ Core package loads successfully\")"

    - name: Test precompilation for circular dependencies
      run: |
        echo "‚öôÔ∏è Testing precompilation for circular dependency warnings..."
        julia --project=. -e "
          using Pkg;
          output = IOBuffer();
          Pkg.precompile(io=output);
          precomp_output = String(take!(output));

          # Check for circular dependency warnings
          if occursin(\"Circular dependency detected\", precomp_output)
            println(\"‚ö†Ô∏è CIRCULAR DEPENDENCY WARNING DETECTED:\");
            println(precomp_output);
            println(\"\\n‚ö†Ô∏è Warning: Circular dependencies found but functionality may still work\");
            println(\"Consider reviewing dependencies according to circular dependency prevention rules\");
          else
            println(\"‚úÖ No circular dependency warnings detected\");
          end
        "

    - name: Test extension loading
      run: |
        echo "üîå Testing extension loading..."
        julia --project=. -e "
          using Globtim;

          # Test available extensions
          println(\"üì¶ Available extensions:\");

          # Try loading weakdeps to trigger extensions
          try
            using Clustering, Distributions;
            println(\"‚úÖ GlobtimAnalysisExt loads successfully\");
          catch e
            println(\"‚ö†Ô∏è Extension loading issue: \$e\");
          end
        "

    - name: Generate dependency report
      if: always()
      run: |
        echo "üìä Generating dependency validation report..."
        julia --project=. -e "
          import Pkg.TOML

          println(\"\\nüìã DEPENDENCY VALIDATION REPORT\");
          println(\"=\"^50);

          # Parse Project.toml directly for full access to all sections
          toml = TOML.parsefile(\"Project.toml\");

          name = get(toml, \"name\", \"unknown\");
          version = get(toml, \"version\", \"unknown\");
          println(\"üì¶ Package: \$name v\$version\");

          deps = length(get(toml, \"deps\", Dict()));
          weakdeps = length(get(toml, \"weakdeps\", Dict()));
          extensions = length(get(toml, \"extensions\", Dict()));

          println(\"üìä Dependencies: \$deps regular, \$weakdeps weak, \$extensions extensions\");

          # Status summary
          println(\"\\n‚úÖ Validation completed - see logs above for details\");
        "